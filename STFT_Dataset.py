import os
import warnings
import numpy as np
import pandas as pd
import torch
import librosa

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1) ê²½ê³  ë¬´ì‹œ (librosa ë¡œë”© ê²½ê³  ë“±)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
warnings.filterwarnings('ignore')

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2) ê²½ë¡œ ì„¤ì •
#    ì‹¤ì œ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DEAM_DATA_ROOT = r'C:\Users\sc\Desktop\dive-to-vibe-mk2\DEAM Dataset'

# â€¢ ì›ë³¸ ì˜¤ë””ì˜¤(mp3) í´ë”
AUDIO_DIR = os.path.join(DEAM_DATA_ROOT, 'DEAM_audio', 'MEMD_audio')

# â€¢ ë¶„ë¦¬ëœ wide-format ì£¼ì„ CSV íŒŒì¼ ê²½ë¡œ
VALENCE_CSV_PATH = os.path.join(
    DEAM_DATA_ROOT,
    'DEAM_Annotations',
    'annotations',
    'annotations averaged per song',
    'dynamic (per second annotations)',
    'valence.csv'
)
AROUSAL_CSV_PATH = os.path.join(
    DEAM_DATA_ROOT,
    'DEAM_Annotations',
    'annotations',
    'annotations averaged per song',
    'dynamic (per second annotations)',
    'arousal.csv'
)

# â€¢ ìµœì¢… .pt íŒŒì¼ ì €ì¥ ê²½ë¡œ
OUTPUT_PT_PATH = './DEAM_Processed/DEAM_dataset.pt'

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3) ìŠ¤í™íŠ¸ë¡œê·¸ë¨ & ì£¼ì„ ë™ê¸°í™” íŒŒë¼ë¯¸í„°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SAMPLE_RATE     = 44100                    # Hz
N_FFT           = 2048                     # FFT ìœˆë„ìš° í¬ê¸°
HOP_LENGTH      = int(0.5 * SAMPLE_RATE)   # 0.5ì´ˆ ê°„ê²© (2Hz annotation)
N_MELS          = 128                      # Mel í•„í„° ë±…í¬ ê°œìˆ˜
EXCLUDE_SECONDS = 15                       # ì• 15ì´ˆ ì˜¤ë””ì˜¤ ì»·

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4) ì¶œë ¥ ë””ë ‰í† ë¦¬ ì¤€ë¹„
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
os.makedirs(os.path.dirname(OUTPUT_PT_PATH), exist_ok=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5) ì£¼ì„ CSV ë¡œë“œ (wide-format)
#    ê° í–‰ì— 'song_id' + 'sample_XXXXms' ì»¬ëŸ¼ë“¤ì´ ìˆìŠµë‹ˆë‹¤.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
val_df = pd.read_csv(VALENCE_CSV_PATH)
aro_df = pd.read_csv(AROUSAL_CSV_PATH)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6) wide-format ì£¼ì„ í–‰ â†’ 1D numpy array ë³€í™˜ í•¨ìˆ˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def extract_annotations_wide(row: pd.Series) -> np.ndarray:
    # 'sample_XXXXms' ë¡œ ì‹œì‘í•˜ëŠ” ì»¬ëŸ¼ ì°¾ê¸°
    sample_cols = [c for c in row.index if c.startswith('sample_')]
    # ê° ì»¬ëŸ¼ëª…ì—ì„œ ë°€ë¦¬ì´ˆ(ms) ê°’ ì¶”ì¶œ í›„ ì •ë ¬
    ms_pairs = [
        (int(c.split('_')[1].replace('ms', '')), c)
        for c in sample_cols
    ]
    ms_pairs.sort(key=lambda x: x[0])
    sorted_cols = [col for _, col in ms_pairs]
    # float array ë°˜í™˜
    return row[sorted_cols].values.astype(float)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 7) ë‹¨ì¼ ê³¡ ì²˜ë¦¬ í•¨ìˆ˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def process_single_song(audio_path: str, song_id: int):
    """
    - ì˜¤ë””ì˜¤ ë¡œë“œ & ì• 15ì´ˆ ì œê±°
    - wide-format ì£¼ì„ì—ì„œ í•´ë‹¹ song_id í–‰ ì¶”ì¶œ â†’ 1D array ë³€í™˜
    - Log-Mel ìŠ¤í™íŠ¸ë¡œê·¸ë¨ ìƒì„±
    - ìŠ¤í™íŠ¸ë¡œê·¸ë¨ í”„ë ˆì„ìˆ˜ì™€ ì£¼ì„ ê¸¸ì´ ë™ê¸°í™”
    - (spectrogram, annotations) íŠœí”Œ ë°˜í™˜ ë˜ëŠ” None
    """
    # 1) ì˜¤ë””ì˜¤ ë¡œë“œ
    y, sr = librosa.load(audio_path, sr=SAMPLE_RATE)
    y = y[int(EXCLUDE_SECONDS * sr):]  # ì• 15ì´ˆ ì œê±°

    # 2) song_id í–‰ ì¶”ì¶œ
    vrow = val_df[val_df['song_id'] == song_id]
    arow = aro_df[aro_df['song_id'] == song_id]
    if vrow.empty or arow.empty:
        print(f"âš ï¸ Skipped song_{song_id}: annotation not found")
        return None

    # 3) wide-format â†’ 1D numpy array
    v_arr = extract_annotations_wide(vrow.iloc[0])
    a_arr = extract_annotations_wide(arow.iloc[0])

    # 4) Log-Mel ìŠ¤í™íŠ¸ë¡œê·¸ë¨
    mel_spec = librosa.feature.melspectrogram(
        y=y, sr=sr,
        n_fft=N_FFT,
        hop_length=HOP_LENGTH,
        n_mels=N_MELS
    )
    log_mel = librosa.power_to_db(mel_spec, ref=np.max)

    # 5) í”„ë ˆì„ìˆ˜ ë™ê¸°í™”
    num_spec = log_mel.shape[1]
    num_ann  = min(len(v_arr), len(a_arr))
    mf       = min(num_spec, num_ann)
    if mf == 0:
        print(f"âš ï¸ Skipped song_{song_id}: zero frames")
        return None

    spec_slice = log_mel[:, :mf]                     # shape = (n_mels, mf)
    ann_slice  = np.stack([v_arr[:mf], a_arr[:mf]], 1)  # shape = (mf, 2)

    return spec_slice, ann_slice

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 8) ë©”ì¸ ë£¨í”„: ëª¨ë“  mp3 ì²˜ë¦¬ â†’ ë¦¬ìŠ¤íŠ¸ì— ìˆ˜ì§‘
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
spectrograms = []
annotations  = []
song_ids     = []

audio_files = sorted(f for f in os.listdir(AUDIO_DIR)
                     if f.lower().endswith('.mp3'))
print(f"ì´ {len(audio_files)}ê°œ ì˜¤ë””ì˜¤ íŒŒì¼ ì²˜ë¦¬ ì‹œì‘...\n")

for fname in audio_files:
    sid  = int(os.path.splitext(fname)[0].split('_')[-1])
    path = os.path.join(AUDIO_DIR, fname)

    result = process_single_song(path, sid)
    if result is None:
        continue

    spec, ann = result
    spectrograms.append(spec)
    annotations.append(ann)
    song_ids.append(sid)
    print(f"âœ… Processed song_{sid}")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 9) í•˜ë‚˜ì˜ .pt íŒŒì¼ë¡œ ì €ì¥
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# - spectrograms: list of (n_mels Ã— frames) numpy arrays
# - annotations:  list of (frames Ã— 2) numpy arrays
# - song_ids:     list of int
spec_tensors = [torch.from_numpy(s).float().unsqueeze(0)
                for s in spectrograms]  # shape = (1, n_mels, frames)
ann_tensors  = [torch.from_numpy(a).float()
                for a in annotations]   # shape = (frames, 2)

torch.save({
    'spectrograms': spec_tensors,
    'annotations' : ann_tensors,
    'song_ids'    : song_ids
}, OUTPUT_PT_PATH)

print(f"\nğŸ‰ ì €ì¥ ì™„ë£Œ: {OUTPUT_PT_PATH}  (ì´ {len(song_ids)}ê³¡)")

